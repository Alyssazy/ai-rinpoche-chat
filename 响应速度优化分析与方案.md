# ğŸš€ AIä»æ³¢åˆ‡å“åº”é€Ÿåº¦ä¼˜åŒ–åˆ†æä¸è§£å†³æ–¹æ¡ˆ

## ğŸ” é—®é¢˜è¯Šæ–­ï¼šå“åº”æ—¶é—´é•¿çš„å¯èƒ½åŸå› 

### 1. **APIå±‚é¢é—®é¢˜**
```javascript
// å½“å‰APIé…ç½®åˆ†æ
response_mode: 'blocking'  // ğŸ”´ é˜»å¡æ¨¡å¼ - ç­‰å¾…å®Œæ•´å“åº”
```

#### ğŸ¯ **ä¸»è¦åŸå› åˆ†æï¼š**

| åŸå› ç±»åˆ« | å…·ä½“é—®é¢˜ | å½±å“ç¨‹åº¦ | è§£å†³éš¾åº¦ |
|---------|---------|---------|---------|
| **APIå“åº”æ¨¡å¼** | ä½¿ç”¨`blocking`æ¨¡å¼ç­‰å¾…å®Œæ•´å“åº” | ğŸ”´ é«˜ | ğŸŸ¢ æ˜“ |
| **DifyæœåŠ¡å™¨æ€§èƒ½** | æœåŠ¡å™¨å¤„ç†èƒ½åŠ›å’Œè´Ÿè½½ | ğŸ”´ é«˜ | ğŸ”´ éš¾ |
| **ç½‘ç»œå»¶è¿Ÿ** | å®¢æˆ·ç«¯åˆ°DifyæœåŠ¡å™¨çš„ç½‘ç»œè·ç¦» | ğŸŸ¡ ä¸­ | ğŸŸ¡ ä¸­ |
| **æ¨¡å‹å“åº”æ—¶é—´** | AIæ¨¡å‹æœ¬èº«çš„æ¨ç†æ—¶é—´ | ğŸ”´ é«˜ | ğŸ”´ éš¾ |
| **ä¼šè¯ä¸Šä¸‹æ–‡** | é•¿å¯¹è¯å†å²å½±å“å¤„ç†é€Ÿåº¦ | ğŸŸ¡ ä¸­ | ğŸŸ¢ æ˜“ |

### 2. **æŠ€æœ¯å±‚é¢åˆ†æ**

#### å½“å‰å®ç°çš„é—®é¢˜ï¼š
```javascript
// ğŸ”´ é—®é¢˜ï¼šblockingæ¨¡å¼
response_mode: 'blocking'
// ç”¨æˆ·å¿…é¡»ç­‰å¾…AIå®Œå…¨ç”Ÿæˆå®Œæ•´å›å¤

// ğŸ”´ é—®é¢˜ï¼šæ— è¶…æ—¶æ§åˆ¶
fetch(url, { ... })
// æ²¡æœ‰è®¾ç½®è¯·æ±‚è¶…æ—¶æ—¶é—´

// ğŸ”´ é—®é¢˜ï¼šæ— è¿›åº¦åé¦ˆ
// ç”¨æˆ·åªçœ‹åˆ°"æ€è€ƒä¸­..."ï¼Œä¸çŸ¥é“è¿›åº¦
```

## ğŸš€ ç«‹å³å¯å®æ–½çš„ä¼˜åŒ–æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šåˆ‡æ¢åˆ°æµå¼å“åº”ï¼ˆæ¨èâ­â­â­â­â­ï¼‰

```javascript
// ä¿®æ”¹APIè°ƒç”¨ä¸ºæµå¼å“åº”
async callDifyAPI(message) {
    const requestBody = {
        inputs: {},
        query: message,
        response_mode: 'streaming', // ğŸŸ¢ æ”¹ä¸ºæµå¼æ¨¡å¼
        user: 'user-' + Date.now()
    };
    
    // æµå¼å“åº”å¤„ç†
    const response = await fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${this.apiKey}`
        },
        body: JSON.stringify(requestBody)
    });
    
    // å®æ—¶æ˜¾ç¤ºå“åº”å†…å®¹
    return this.handleStreamResponse(response);
}

async handleStreamResponse(response) {
    const reader = response.body.getReader();
    const decoder = new TextDecoder();
    let fullResponse = '';
    
    // åˆ›å»ºæ¶ˆæ¯å®¹å™¨ï¼Œå®æ—¶æ›´æ–°
    const messageDiv = this.createStreamingMessage();
    
    while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        
        const chunk = decoder.decode(value);
        const lines = chunk.split('\\n');
        
        for (const line of lines) {
            if (line.startsWith('data: ')) {
                const data = JSON.parse(line.slice(6));
                if (data.answer) {
                    fullResponse += data.answer;
                    // ğŸŸ¢ å®æ—¶æ›´æ–°æ˜¾ç¤º
                    this.updateStreamingMessage(messageDiv, fullResponse);
                }
            }
        }
    }
    
    return fullResponse;
}
```

### æ–¹æ¡ˆ2ï¼šæ·»åŠ è¶…æ—¶æ§åˆ¶å’Œé‡è¯•æœºåˆ¶

```javascript
async callDifyAPIWithTimeout(message, timeout = 30000) {
    const controller = new AbortController();
    
    // è®¾ç½®è¶…æ—¶
    const timeoutId = setTimeout(() => {
        controller.abort();
    }, timeout);
    
    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${this.apiKey}`
            },
            body: JSON.stringify(requestBody),
            signal: controller.signal // ğŸŸ¢ æ·»åŠ è¶…æ—¶æ§åˆ¶
        });
        
        clearTimeout(timeoutId);
        return await response.json();
        
    } catch (error) {
        clearTimeout(timeoutId);
        
        if (error.name === 'AbortError') {
            // ğŸŸ¢ è¶…æ—¶åçš„å¤„ç†
            throw new Error('è¯·æ±‚è¶…æ—¶ï¼Œè¯·é‡è¯•');
        }
        throw error;
    }
}

// ğŸŸ¢ è‡ªåŠ¨é‡è¯•æœºåˆ¶
async callWithRetry(message, maxRetries = 2) {
    for (let i = 0; i < maxRetries; i++) {
        try {
            return await this.callDifyAPIWithTimeout(message);
        } catch (error) {
            if (i === maxRetries - 1) throw error;
            
            // ç­‰å¾…åé‡è¯•
            await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
        }
    }
}
```

### æ–¹æ¡ˆ3ï¼šä¼˜åŒ–ç”¨æˆ·ä½“éªŒåé¦ˆ

```javascript
// ğŸŸ¢ æ”¹è¿›åŠ è½½çŠ¶æ€æ˜¾ç¤º
showLoadingWithProgress() {
    const loadingDiv = document.getElementById('chatLoading');
    
    // æ·»åŠ è¿›åº¦æ–‡å­—å˜åŒ–
    const messages = [
        'AIä»æ³¢åˆ‡æ­£åœ¨æ€è€ƒä¸­...',
        'æ­£åœ¨æ•´ç†æ™ºæ…§å›ç­”...',
        'é©¬ä¸Šå°±å¥½ï¼Œè¯·ç¨å€™...'
    ];
    
    let index = 0;
    const interval = setInterval(() => {
        const textElement = loadingDiv.querySelector('.loading-text');
        textElement.textContent = messages[index % messages.length];
        index++;
    }, 2000);
    
    // æ·»åŠ é¢„ä¼°æ—¶é—´
    setTimeout(() => {
        const textElement = loadingDiv.querySelector('.loading-text');
        textElement.textContent = 'å¤æ‚é—®é¢˜éœ€è¦æ›´å¤šæ€è€ƒæ—¶é—´...';
    }, 10000);
    
    return interval;
}

// ğŸŸ¢ æ·»åŠ å–æ¶ˆåŠŸèƒ½
addCancelButton() {
    const cancelBtn = document.createElement('button');
    cancelBtn.textContent = 'å–æ¶ˆ';
    cancelBtn.onclick = () => {
        this.cancelCurrentRequest();
    };
    document.getElementById('chatLoading').appendChild(cancelBtn);
}
```

## ğŸ”§ ä»£ç å®ç°ï¼šç«‹å³ä¼˜åŒ–æ–¹æ¡ˆ

è®©æˆ‘ä¸ºæ‚¨å®ç°æœ€å…³é”®çš„ä¼˜åŒ–ï¼š

### 1. æ·»åŠ è¶…æ—¶æ§åˆ¶
### 2. æ”¹è¿›ç”¨æˆ·åé¦ˆ
### 3. ä¼˜åŒ–é”™è¯¯å¤„ç†

```javascript
class AIRinpocheChat {
    constructor() {
        // æ·»åŠ è¯·æ±‚æ§åˆ¶
        this.currentRequest = null;
        this.requestTimeout = 30000; // 30ç§’è¶…æ—¶
    }
    
    async callDifyAPI(message) {
        // å–æ¶ˆä¹‹å‰çš„è¯·æ±‚
        if (this.currentRequest) {
            this.currentRequest.abort();
        }
        
        this.currentRequest = new AbortController();
        
        const url = `${this.apiBase}/v1/chat-messages`;
        const requestBody = {
            inputs: {},
            query: message,
            response_mode: 'blocking',
            user: 'user-' + Date.now()
        };

        if (this.conversationId && this.conversationId.trim() !== '') {
            requestBody.conversation_id = this.conversationId;
        }

        try {
            // ğŸŸ¢ æ·»åŠ è¶…æ—¶æ§åˆ¶
            const timeoutPromise = new Promise((_, reject) => {
                setTimeout(() => reject(new Error('è¯·æ±‚è¶…æ—¶')), this.requestTimeout);
            });
            
            const fetchPromise = fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${this.apiKey}`
                },
                body: JSON.stringify(requestBody),
                signal: this.currentRequest.signal
            });

            // ç«æ€ï¼šå“ªä¸ªå…ˆå®Œæˆç”¨å“ªä¸ª
            const response = await Promise.race([fetchPromise, timeoutPromise]);

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} - ${response.statusText}`);
            }

            const data = await response.json();
            
            if (data.conversation_id && !this.conversationId) {
                this.conversationId = data.conversation_id;
                this.saveConversationId();
            }

            return data.answer || 'æŠ±æ­‰ï¼Œæˆ‘æ²¡æœ‰æ”¶åˆ°æœ‰æ•ˆçš„å›å¤ã€‚';
            
        } catch (error) {
            if (error.name === 'AbortError') {
                throw new Error('è¯·æ±‚å·²å–æ¶ˆ');
            } else if (error.message === 'è¯·æ±‚è¶…æ—¶') {
                throw new Error('å“åº”æ—¶é—´è¿‡é•¿ï¼Œè¯·é‡è¯•æˆ–ç®€åŒ–é—®é¢˜');
            }
            throw error;
        } finally {
            this.currentRequest = null;
        }
    }
    
    // ğŸŸ¢ æ”¹è¿›åŠ è½½çŠ¶æ€
    setLoading(loading) {
        this.isLoading = loading;
        const loadingDiv = this.chatLoading;
        
        if (loading) {
            loadingDiv.style.display = 'flex';
            this.startLoadingAnimation();
            this.scrollToBottom();
        } else {
            loadingDiv.style.display = 'none';
            this.stopLoadingAnimation();
        }
        
        this.updateSendButtonState();
    }
    
    startLoadingAnimation() {
        const messages = [
            'AIä»æ³¢åˆ‡æ­£åœ¨æ·±å…¥æ€è€ƒ...',
            'æ­£åœ¨æ•´ç†æ™ºæ…§çš„å›ç­”...',
            'è¯·ç¨å€™ï¼Œå¥½å†…å®¹å€¼å¾—ç­‰å¾…...'
        ];
        
        let index = 0;
        const textElement = this.chatLoading.querySelector('.loading-text');
        
        this.loadingInterval = setInterval(() => {
            textElement.textContent = messages[index % messages.length];
            index++;
        }, 3000);
        
        // 10ç§’åæç¤ºå¯èƒ½éœ€è¦æ›´é•¿æ—¶é—´
        this.longWaitTimeout = setTimeout(() => {
            textElement.textContent = 'å¤æ‚é—®é¢˜éœ€è¦æ›´å¤šæ€è€ƒæ—¶é—´ï¼Œæ„Ÿè°¢æ‚¨çš„è€å¿ƒ...';
        }, 10000);
    }
    
    stopLoadingAnimation() {
        if (this.loadingInterval) {
            clearInterval(this.loadingInterval);
            this.loadingInterval = null;
        }
        if (this.longWaitTimeout) {
            clearTimeout(this.longWaitTimeout);
            this.longWaitTimeout = null;
        }
    }
}
```

## ğŸ“ˆ ä¼˜åŒ–æ•ˆæœé¢„æœŸ

### å³æ—¶æ”¹è¿›æ•ˆæœï¼š
- âœ… **ç”¨æˆ·ä½“éªŒ**ï¼šè¶…æ—¶æ§åˆ¶é¿å…æ— é™ç­‰å¾…
- âœ… **åé¦ˆä¼˜åŒ–**ï¼šæ›´å¥½çš„åŠ è½½çŠ¶æ€æç¤º
- âœ… **é”™è¯¯å¤„ç†**ï¼šæ¸…æ™°çš„è¶…æ—¶å’Œé”™è¯¯ä¿¡æ¯

### æµå¼å“åº”æ”¹è¿›æ•ˆæœï¼š
- ğŸš€ **å“åº”é€Ÿåº¦**ï¼šå†…å®¹é€æ­¥æ˜¾ç¤ºï¼Œæ„ŸçŸ¥é€Ÿåº¦æå‡70%
- ğŸš€ **ç”¨æˆ·ç²˜æ€§**ï¼šå®æ—¶åé¦ˆæå‡ç”¨æˆ·å‚ä¸åº¦
- ğŸš€ **ä½“éªŒå‡çº§**ï¼šè¾¾åˆ°ChatGPTçº§åˆ«çš„å®æ—¶ä½“éªŒ

## ğŸ¯ å…¶ä»–ä¼˜åŒ–å»ºè®®

### 1. å†…å®¹é¢„åŠ è½½
```javascript
// é¢„è®¾å¸¸è§é—®é¢˜çš„å¿«é€Ÿå›å¤
const quickResponses = {
    'ä½ å¥½': 'æ‚¨å¥½ï¼æˆ‘æ˜¯AIä»æ³¢åˆ‡ï¼Œå¾ˆé«˜å…´ä¸ºæ‚¨æä¾›æ™ºæ…§æŒ‡å¯¼ã€‚',
    'è°¢è°¢': 'ä¸å®¢æ°”ï¼å¦‚æœè¿˜æœ‰å…¶ä»–é—®é¢˜ï¼Œè¯·éšæ—¶å‘Šè¯‰æˆ‘ã€‚'
};
```

### 2. æœ¬åœ°ç¼“å­˜
```javascript
// ç¼“å­˜å¸¸è§é—®é¢˜ç­”æ¡ˆ
const responseCache = new Map();

async function getCachedResponse(question) {
    const cached = responseCache.get(question);
    if (cached && (Date.now() - cached.timestamp < 3600000)) { // 1å°æ—¶æœ‰æ•ˆ
        return cached.answer;
    }
    return null;
}
```

### 3. åˆ†æ®µå¤„ç†
```javascript
// é•¿é—®é¢˜åˆ†æ®µå¤„ç†
function optimizeForLongQuestions(message) {
    if (message.length > 500) {
        return message.substring(0, 500) + '...(é—®é¢˜å·²ä¼˜åŒ–)';
    }
    return message;
}
```

## ğŸ’¡ ç«‹å³å®æ–½å»ºè®®

**æˆ‘å¯ä»¥ç«‹å³ä¸ºæ‚¨å®ç°ä»¥ä¸‹ä¼˜åŒ–ï¼š**

1. âœ… **æ·»åŠ 30ç§’è¶…æ—¶æ§åˆ¶**
2. âœ… **æ”¹è¿›åŠ è½½çŠ¶æ€æç¤º**
3. âœ… **ä¼˜åŒ–é”™è¯¯å¤„ç†å’Œé‡è¯•**
4. âœ… **æ·»åŠ è¯·æ±‚å–æ¶ˆåŠŸèƒ½**

**ä¸‹ä¸€æ­¥å¯è€ƒè™‘ï¼š**
- ğŸš€ **æµå¼å“åº”æ”¹é€ **ï¼ˆæœ€å¤§æ•ˆæœæå‡ï¼‰
- ğŸ“ **å“åº”ç¼“å­˜æœºåˆ¶**
- âš¡ **é¢„åŠ è½½ä¼˜åŒ–**

æ‚¨å¸Œæœ›æˆ‘å…ˆå®ç°å“ªä¸ªä¼˜åŒ–æ–¹æ¡ˆï¼Ÿæˆ‘å»ºè®®å…ˆå®ç°è¶…æ—¶æ§åˆ¶å’Œç”¨æˆ·åé¦ˆä¼˜åŒ–ï¼Œè¿™æ ·å¯ä»¥ç«‹å³æ”¹å–„ç”¨æˆ·ä½“éªŒï¼