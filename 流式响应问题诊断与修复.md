# ğŸ”§ æµå¼å“åº”é—®é¢˜è¯Šæ–­ä¸ä¿®å¤æŒ‡å—

## ğŸš¨ é—®é¢˜ç°è±¡
ç”¨æˆ·åé¦ˆï¼šåˆ·æ–°é¡µé¢åï¼Œå†…å®¹æ²¡æœ‰é€å­—é€å¥å‡ºç°ï¼Œè¿˜æ˜¯è¦ç­‰å¾ˆä¹…ç„¶åä¸€å †æ–‡å­—åŒæ—¶å‡ºç°ã€‚

## ğŸ” å¯èƒ½åŸå› åˆ†æ

### 1. **æœ€å¸¸è§åŸå› ï¼šDify APIä¸æ”¯æŒæµå¼å“åº”**
```
ğŸ“Š æ¦‚ç‡ï¼š90%
ğŸ’¡ åŸå› ï¼šéƒ¨åˆ†Difyé…ç½®æˆ–ç‰ˆæœ¬å¯èƒ½ä¸æ”¯æŒstreamingæ¨¡å¼
ğŸ”§ ç—‡çŠ¶ï¼šAPIä»è¿”å›å®Œæ•´å†…å®¹ï¼Œè€Œéæµå¼æ•°æ®
```

### 2. **ç½‘ç»œç¯å¢ƒé—®é¢˜**
```
ğŸ“Š æ¦‚ç‡ï¼š70%
ğŸ’¡ åŸå› ï¼šæŸäº›ç½‘ç»œç¯å¢ƒä¼šç¼“å†²æµå¼æ•°æ®
ğŸ”§ ç—‡çŠ¶ï¼šæ•°æ®è¢«ç½‘ç»œå±‚åˆå¹¶åä¸€æ¬¡æ€§ä¼ è¾“
```

### 3. **æµè§ˆå™¨ç¼“å­˜é—®é¢˜**
```
ğŸ“Š æ¦‚ç‡ï¼š60%
ğŸ’¡ åŸå› ï¼šæµè§ˆå™¨ç¼“å­˜äº†æ—§ç‰ˆæœ¬ä»£ç 
ğŸ”§ ç—‡çŠ¶ï¼šä»£ç æ›´æ–°æœªç”Ÿæ•ˆ
```

### 4. **ä»£ç é€»è¾‘é—®é¢˜**
```
ğŸ“Š æ¦‚ç‡ï¼š40%
ğŸ’¡ åŸå› ï¼šæµå¼å¤„ç†é€»è¾‘æœ‰bug
ğŸ”§ ç—‡çŠ¶ï¼šæ•°æ®æ¥æ”¶æ­£å¸¸ä½†æ˜¾ç¤ºå¼‚å¸¸
```

## ğŸ› ï¸ ç«‹å³è¯Šæ–­æ­¥éª¤

### æ­¥éª¤1ï¼šæ£€æŸ¥æ§åˆ¶å°æ—¥å¿—
```javascript
// æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…· (F12)
// æŸ¥çœ‹Consoleæ ‡ç­¾ï¼Œå‘é€ä¸€æ¡æ¶ˆæ¯åè§‚å¯Ÿæ—¥å¿—

æœŸæœ›çœ‹åˆ°çš„æ—¥å¿—ï¼š
âœ… "ğŸ“ æ”¶åˆ°æµå¼æ•°æ®: æ‚¨å¥½ï¼æˆ‘æ˜¯AIä»æ³¢åˆ‡..."
âœ… "âœ… å·²æ›´æ–°æ˜¾ç¤º, æ€»é•¿åº¦: 25"
âœ… "ğŸ“ æ”¶åˆ°æµå¼æ•°æ®: å¾ˆé«˜å…´ä¸ºæ‚¨æä¾›..."
âœ… "âœ… å·²æ›´æ–°æ˜¾ç¤º, æ€»é•¿åº¦: 58"

å¦‚æœçœ‹åˆ°ï¼š
âŒ "âš ï¸ æµå¼å®¹å™¨ä¸å­˜åœ¨ï¼Œæ— æ³•å®æ—¶æ›´æ–°"
âŒ æ²¡æœ‰ä»»ä½•"ğŸ“ æ”¶åˆ°æµå¼æ•°æ®"æ—¥å¿—
âŒ åªæœ‰æœ€åçš„å®Œæ•´å“åº”

â†’ è¯´æ˜é—®é¢˜ç¡®å®å­˜åœ¨
```

### æ­¥éª¤2ï¼šæ£€æŸ¥ç½‘ç»œè¯·æ±‚
```javascript
// åœ¨å¼€å‘è€…å·¥å…·ä¸­åˆ‡æ¢åˆ°Networkæ ‡ç­¾
// å‘é€æ¶ˆæ¯ï¼ŒæŸ¥çœ‹APIè¯·æ±‚

æ£€æŸ¥è¦ç‚¹ï¼š
1. è¯·æ±‚URLæ˜¯å¦ä¸ºï¼šhttps://api.dify.ai/v1/chat-messages
2. è¯·æ±‚æ–¹æ³•æ˜¯å¦ä¸ºï¼šPOST
3. è¯·æ±‚ä½“ä¸­response_modeæ˜¯å¦ä¸ºï¼š"streaming"
4. å“åº”å¤´æ˜¯å¦åŒ…å«ï¼šContent-Type: text/event-stream
5. å“åº”æ˜¯å¦å®æ—¶æ¥æ”¶ï¼ˆæ—¶é—´è½´æŒç»­æ›´æ–°ï¼‰

å¦‚æœresponse_modeä»æ˜¾ç¤º"blocking" â†’ ä»£ç æœªæ›´æ–°
å¦‚æœContent-Typeä¸æ˜¯text/event-stream â†’ APIä¸æ”¯æŒæµå¼
```

## ğŸš€ ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šå¼ºåˆ¶åˆ·æ–°ç¼“å­˜ï¼ˆé¦–é€‰ï¼‰
```bash
# æ–¹æ³•1ï¼šå¼ºåˆ¶åˆ·æ–°
Ctrl + F5 (Windows)
Cmd + Shift + R (Mac)

# æ–¹æ³•2ï¼šæ¸…é™¤ç¼“å­˜
1. æ‰“å¼€å¼€å‘è€…å·¥å…· (F12)
2. å³é”®åˆ·æ–°æŒ‰é’®
3. é€‰æ‹©"æ¸…ç©ºç¼“å­˜å¹¶ç¡¬æ€§é‡æ–°åŠ è½½"

# æ–¹æ³•3ï¼šæ— ç—•æ¨¡å¼æµ‹è¯•
Ctrl + Shift + N æ‰“å¼€æ— ç—•çª—å£æµ‹è¯•
```

### æ–¹æ¡ˆ2ï¼šAPIå…¼å®¹æ€§æ£€æµ‹å’Œé™çº§
æˆ‘æ¥ä¸ºæ‚¨æ·»åŠ APIå…¼å®¹æ€§æ£€æµ‹ï¼š

```javascript
// æ·»åŠ åˆ°script.jsçš„æ„é€ å‡½æ•°ä¸­
constructor() {
    // ... ç°æœ‰ä»£ç  ...
    this.streamingSupported = null; // æµå¼æ”¯æŒæ£€æµ‹
    this.fallbackMode = false;      // é™çº§æ¨¡å¼æ ‡è®°
}

// æ£€æµ‹æµå¼æ”¯æŒ
async detectStreamingSupport() {
    console.log('ğŸ” æ£€æµ‹APIæµå¼å“åº”æ”¯æŒ...');
    
    try {
        const testResponse = await fetch(`${this.apiBase}/v1/chat-messages`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${this.apiKey}`
            },
            body: JSON.stringify({
                inputs: {},
                query: 'test',
                response_mode: 'streaming',
                user: 'test-user'
            })
        });
        
        const contentType = testResponse.headers.get('Content-Type');
        this.streamingSupported = contentType && contentType.includes('text/event-stream');
        
        console.log('ğŸ“Š æµå¼å“åº”æ”¯æŒ:', this.streamingSupported ? 'âœ… æ”¯æŒ' : 'âŒ ä¸æ”¯æŒ');
        
        if (!this.streamingSupported) {
            this.fallbackMode = true;
            console.warn('âš ï¸ APIä¸æ”¯æŒæµå¼å“åº”ï¼Œå°†ä½¿ç”¨é™çº§æ¨¡å¼');
        }
        
    } catch (error) {
        console.error('ğŸš¨ æµå¼æ”¯æŒæ£€æµ‹å¤±è´¥:', error);
        this.streamingSupported = false;
        this.fallbackMode = true;
    }
}
```

### æ–¹æ¡ˆ3ï¼šæ··åˆæ¨¡å¼å®ç°
```javascript
// ä¿®æ”¹è°ƒç”¨é€»è¾‘ï¼Œæ”¯æŒè‡ªåŠ¨é™çº§
async sendMessage() {
    const message = this.chatInput.value.trim();
    if (!message || this.isLoading) return;
    
    // é—®é¢˜é•¿åº¦ä¼˜åŒ–æç¤º
    if (message.length > 1000) {
        const confirmed = confirm('æ‚¨çš„é—®é¢˜è¾ƒé•¿ï¼Œå¯èƒ½éœ€è¦æ›´å¤šæ—¶é—´å¤„ç†ã€‚å»ºè®®ç®€åŒ–é—®é¢˜ä»¥è·å¾—æ›´å¿«å“åº”ã€‚\\n\\næ˜¯å¦ç»§ç»­å‘é€ï¼Ÿ');
        if (!confirmed) return;
    }
    
    // ä¿å­˜ç”¨æˆ·æ¶ˆæ¯ç”¨äºé‡æ–°ç”Ÿæˆ
    this.lastUserMessage = message;
    
    this.showChatInterface();
    this.addMessage('user', message);
    this.chatInput.value = '';
    this.adjustTextareaHeight();
    
    try {
        // ğŸš€ æ ¹æ®APIæ”¯æŒæƒ…å†µé€‰æ‹©æ¨¡å¼
        if (this.streamingSupported !== false) {
            // å°è¯•æµå¼å“åº”
            await this.callDifyAPIStreaming(message);
        } else {
            // é™çº§åˆ°ä¼ ç»Ÿæ¨¡å¼
            this.setLoading(true);
            const response = await this.callDifyAPIBlocking(message);
            this.addMessage('ai', response);
        }
    } catch (error) {
        console.error('APIè°ƒç”¨å¤±è´¥:', error);
        
        // å¦‚æœæµå¼å¤±è´¥ï¼Œå°è¯•é™çº§
        if (!this.fallbackMode && error.message.includes('streaming')) {
            console.log('ğŸ”„ æµå¼å¤±è´¥ï¼Œå°è¯•é™çº§æ¨¡å¼...');
            this.fallbackMode = true;
            try {
                this.setLoading(true);
                const response = await this.callDifyAPIBlocking(message);
                this.addMessage('ai', response);
                return;
            } catch (fallbackError) {
                console.error('é™çº§æ¨¡å¼ä¹Ÿå¤±è´¥:', fallbackError);
            }
        }
        
        // é”™è¯¯å¤„ç†...
        let errorMessage = 'æŠ±æ­‰ï¼Œæˆ‘ç°åœ¨æ— æ³•å›åº”æ‚¨çš„é—®é¢˜ã€‚';
        // ... ç°æœ‰é”™è¯¯å¤„ç†é€»è¾‘ ...
        this.addMessage('ai', errorMessage);
    } finally {
        this.setLoading(false);
    }
}

// ä¼ ç»Ÿblockingæ¨¡å¼APIè°ƒç”¨
async callDifyAPIBlocking(message) {
    // å–æ¶ˆä¹‹å‰çš„è¯·æ±‚
    if (this.currentRequest) {
        this.currentRequest.abort();
    }
    
    this.currentRequest = new AbortController();
    
    const requestBody = {
        inputs: {},
        query: message,
        response_mode: 'blocking', // ä¼ ç»Ÿæ¨¡å¼
        user: 'user-' + Date.now()
    };

    if (this.conversationId && this.conversationId.trim() !== '') {
        requestBody.conversation_id = this.conversationId;
    }

    const response = await fetch(`${this.apiBase}/v1/chat-messages`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${this.apiKey}`
        },
        body: JSON.stringify(requestBody),
        signal: this.currentRequest.signal
    });

    if (!response.ok) {
        throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
    }

    const data = await response.json();
    
    if (data.conversation_id && !this.conversationId) {
        this.conversationId = data.conversation_id;
        this.saveConversationId();
    }

    return data.answer || 'æŠ±æ­‰ï¼Œæˆ‘æ²¡æœ‰æ”¶åˆ°æœ‰æ•ˆçš„å›å¤ã€‚';
}
```

## ğŸ“‹ ç«‹å³æ‰§è¡Œæ£€æŸ¥æ¸…å•

### âœ… ç”¨æˆ·æ“ä½œæ£€æŸ¥æ¸…å•ï¼š
- [ ] **å¼ºåˆ¶åˆ·æ–°é¡µé¢** (Ctrl+F5)
- [ ] **æ¸…é™¤æµè§ˆå™¨ç¼“å­˜**
- [ ] **ä½¿ç”¨æ— ç—•æ¨¡å¼æµ‹è¯•**
- [ ] **æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—**
- [ ] **æŸ¥çœ‹ç½‘ç»œè¯·æ±‚è¯¦æƒ…**

### âœ… æŠ€æœ¯æ£€æŸ¥æ¸…å•ï¼š
- [ ] **ç¡®è®¤response_modeä¸ºstreaming**
- [ ] **éªŒè¯APIå“åº”å¤´Content-Type**
- [ ] **æ£€æŸ¥æµå¼æ•°æ®æ˜¯å¦åˆ†æ®µæ¥æ”¶**
- [ ] **ç¡®è®¤currentStreamingTextä¸ä¸ºnull**
- [ ] **éªŒè¯updateStreamingMessageè¢«è°ƒç”¨**

## ğŸ¯ å¿«é€Ÿæµ‹è¯•æ–¹æ³•

### 1åˆ†é’Ÿå¿«é€Ÿæµ‹è¯•ï¼š
```javascript
// åœ¨æ§åˆ¶å°è¿è¡Œè¿™æ®µä»£ç æµ‹è¯•
console.log('ğŸ§ª å¿«é€Ÿæµ‹è¯•æµå¼åŠŸèƒ½...');

// æ£€æŸ¥å…³é”®å˜é‡
const chatInstance = window.aiRinpocheChat;
if (chatInstance) {
    console.log('âœ… AIå®ä¾‹å­˜åœ¨');
    console.log('ğŸ“Š å½“å‰é…ç½®:', {
        apiBase: chatInstance.apiBase,
        conversationId: chatInstance.conversationId,
        isLoading: chatInstance.isLoading,
        currentStreamingDiv: !!chatInstance.currentStreamingDiv
    });
} else {
    console.error('âŒ AIå®ä¾‹ä¸å­˜åœ¨ï¼Œå¯èƒ½ä»£ç æœªåŠ è½½');
}

// æ£€æŸ¥CSSæ ·å¼
const streamingStyle = document.querySelector('style') || document.styleSheets[0];
console.log('ğŸ¨ æ ·å¼è¡¨æ•°é‡:', document.styleSheets.length);
```

## ğŸš¨ ç´§æ€¥å›é€€æ–¹æ¡ˆ

å¦‚æœæµå¼å“åº”å®Œå…¨æ— æ³•å·¥ä½œï¼Œå¯ä»¥ç«‹å³å›é€€åˆ°ç¨³å®šç‰ˆæœ¬ï¼š

```javascript
// ä¸´æ—¶ç¦ç”¨æµå¼å“åº”ï¼ˆåœ¨æ„é€ å‡½æ•°ä¸­æ·»åŠ ï¼‰
constructor() {
    // ... ç°æœ‰ä»£ç  ...
    this.forceBlockingMode = true; // ğŸš¨ ç´§æ€¥å›é€€å¼€å…³
}

// ä¿®æ”¹sendMessageé€»è¾‘
if (this.forceBlockingMode) {
    // ä½¿ç”¨ä¼ ç»Ÿæ¨¡å¼
    this.setLoading(true);
    const response = await this.callDifyAPIBlocking(message);
    this.addMessage('ai', response);
} else {
    // ä½¿ç”¨æµå¼æ¨¡å¼
    await this.callDifyAPIStreaming(message);
}
```

## ğŸ“ æ•…éšœæ’é™¤æ”¯æŒ

### å¸¸è§é—®é¢˜è§£ç­”ï¼š

**Q: ä¸ºä»€ä¹ˆæµå¼å“åº”ä¸å·¥ä½œï¼Ÿ**
A: æœ€å¸¸è§åŸå› æ˜¯Dify APIé…ç½®é—®é¢˜æˆ–ç½‘ç»œç¯å¢ƒé™åˆ¶ã€‚

**Q: å¦‚ä½•ç¡®è®¤æµå¼å“åº”æ˜¯å¦çœŸçš„å¼€å¯ï¼Ÿ**  
A: æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—ï¼Œåº”è¯¥çœ‹åˆ°"ğŸ“ æ”¶åˆ°æµå¼æ•°æ®"çš„æŒç»­è¾“å‡ºã€‚

**Q: å¯ä»¥å¼ºåˆ¶ä½¿ç”¨ä¼ ç»Ÿæ¨¡å¼å—ï¼Ÿ**
A: å¯ä»¥ï¼Œè®¾ç½®`this.forceBlockingMode = true`å³å¯ã€‚

**Q: æµå¼å“åº”å¤±è´¥ä¼šå½±å“å…¶ä»–åŠŸèƒ½å—ï¼Ÿ**
A: ä¸ä¼šï¼Œä»£ç æœ‰å®Œæ•´çš„é™çº§æœºåˆ¶ã€‚

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **ç«‹å³æ‰§è¡Œ**ï¼šå¼ºåˆ¶åˆ·æ–°æµè§ˆå™¨ç¼“å­˜
2. **æ£€æŸ¥æ—¥å¿—**ï¼šæŸ¥çœ‹æ§åˆ¶å°è¾“å‡ºè¯Šæ–­é—®é¢˜
3. **ç½‘ç»œæµ‹è¯•**ï¼šç¡®è®¤APIè¯·æ±‚æ ¼å¼æ­£ç¡®
4. **é™çº§æµ‹è¯•**ï¼šå¦‚æœ‰é—®é¢˜å¯ç”¨blockingæ¨¡å¼
5. **åé¦ˆç»“æœ**ï¼šå‘Šè¯‰æˆ‘å…·ä½“çœ‹åˆ°äº†ä»€ä¹ˆæ—¥å¿—

**ğŸ’¡ è®°ä½ï¼šå³ä½¿æµå¼å“åº”æš‚æ—¶ä¸å·¥ä½œï¼Œä¼ ç»Ÿæ¨¡å¼ä»ç„¶æ¯”ä¹‹å‰æœ‰æ˜¾è‘—æ”¹è¿›ï¼ˆ30ç§’è¶…æ—¶æ§åˆ¶ã€æ™ºèƒ½é”™è¯¯å¤„ç†ç­‰ï¼‰ï¼**